---
output:
  pdf_document: default
  word_document: default
  html_document: default
---
---
#Recreate WTC 4 Isotope Analsyis
#Firstly set a local directory to save the HQ images too
```{r}
setwd("C:/Users/Richard/Desktop/WTC4-TreePhys-Draft")
```
#the following explains most of the variables used

#Variable definitions: 
##"chamber": chamber number ("C01", "C02", etc) 
##"T_treatment": temperature treatment ("ambient", or "warmed") 
##"DateTime": Date and Time combination variable, in "YYYY-MM-DD HH:MM:SS", AEST 
##"FluxCO2": Chamber CO2 flux. The net exchange of CO2 between the tree and the chamber air (mmol/s). See Barton  et al. 2010 Ag For Met for details.
##"FluxH2O": Chamber H2O flux (mol/s). See Barton  et al. 2010 Ag For Met for details.
##“DoorCnt”: The number of times the door was open during the current 15-minute measurement period. When this value is > 0, the flux calculations are likely incorrect, because they do not account for all sources of CO2 and H2O, like a big breathing human.
##"Tair_al": air temperature (degrees C) inside each WTC as measured by the Allerton system. 
##“RH_al”: the relative humidity (%) inside each WTC as measured by the Allerton system. This is a shielded and aspirated RH sensor mounted in the canopy of each tree.
##“DP_al”: the dew point (degrees C) inside each WTC as measured by central IRGA. Note that DP_al and RH_al are measured by separate sensors, but the values should correspond very strongly.
##"CO2centralCh": chamber CO2 concentration (ppm, also umol mol-1) as measured by the central WTC Li-7000 IRGA 
##“CO2L”: chamber CO2 concentration (ppm, also umol mol-1) as measured by the local IRGA mounted on each WTC
##“Taref_al”: the outside air temperature (degrees C)
##“RHref_al”: the outside relative humidity
##"PAR": incident photosynthetically active radiation as measured by the sensor atop each WTC (umol m-2 s-1). Note that these sensors are occasionally shaded in the morning by the nearby Euc trees and in the evening by the pecans, and chambers are differentially affected. Also this PAR sensor is at the top of the canopy, so virtually all of the leaves will be experiencing PAR that is different than this value.
##“F”: the fresh air input of CO2 into the chamber. (mmol s-1)
##“v”: the output of CO2 from the chamber to the atmosphere. Lost to leaks to balance the pressure given the fresh air input. (mmol s-1)
##“ICO2”: the rate of CO2 injection from tank gas. (mmol s-1)
##“deltaS”: the rate of CO2 accumulation within the chamber relative to the last 15-minute cycle. This is the storage flux, to account for times when the concentration of CO2 has increased or decreased. (mmol s-1)
##“CONDH2O”: the rate of H2O condensation out of the chamber and measured by the tipping bucket. (mol s-1)
##“Vwat”: the output of H2O from the chamber to the atmosphere. Lost to leaks to balance the pressure given the fresh air input. (mol s-1)
##“Fwat”: the fresh air input of H2O into the chamber. (mol s-1)
##“deltaS”: the rate of H2O accumulation within the chamber relative to the last 15-minute cycle. This is the storage flux, to account for times when the concentration of H2O has increased or decreased. (mol s-1)

#Figure 2
#(a)
```{r}
library(lubridate);library(ggplot2);library(xts);library(dplyr);library(grid);library(cowplot)
library(plantecophys);library(akima);library(doBy);library(reshape2);library(gdata);library(ggpubr);
library(data.table);library(rmarkdown);library(tinytex);library(knitr)# Load Packages 
googledriveWTC4ISOTOPEID <- "1RNzYApcCO1D1sr_mVQgQVSQFIWNWlqVm"
df<- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", googledriveWTC4ISOTOPEID)) #best to load this in andthe # it out
#df = df[complete.cases(df), ]
df["Td"]<-(dmy_hm(df$stime, quiet=TRUE, tz="UTC"));summary(df$Td)
df$date <- as.Date(df$Td, format = "%Y-%m-%d") ; summary(df$date); str(df$date)
df["month"]<-format(df$Td,"%m");str(df$month)
df$hm <- format(df$Td, "%H") ; summary(df$hm)
df["week"]<-strftime(df$Td,format="%W",tz="UTC");str(df$week)
##Extract flux data relevant to isotope
start<-ymd_hms("2016-08-28 12:00:00 UTC");summary(start)
end<-ymd_hms("2016-11-26 12:00:00")
int<-interval(start, end); summary(int)
df<-subset(df, df$Td %within% int);head(df$Td);tail(df$Td)
#Remove outliers
df<-subset(df, df$d18O.corrected <= -8)
df<-subset(df, df$d18O.corrected >= -20)
dftrt<-data.frame(df$hm, df$month, df$d18O.corrected, df$T_treatment, df$Td);str(dftrt)
dft<-dftrt %>% group_by(df.T_treatment, df.Td) %>% summarise_at(.vars = names(.)[3:3], na.rm=TRUE, .funs = c(mean))
dft<-subset(dft,df.T_treatment == "atm") #Only take atmosphere data
#Sort the data into Time Class
dft$date <- as.Date(dft$df.Td, format = "%Y-%m-%d") 
dft["month"]<-format(dft$df.Td,"%m");str(dft$month)
dft["monthday"]<-format(dft$df.Td,"%m%d");str(dft$monthday)
dft<-transform(dft,day=as.numeric(factor(monthday))) #day
dft<-as.data.frame(dft)
dft$hm <- format(dft$df.Td, "%H") 
dfsml<-data.frame(dft$hm, dft$day, dft$df.d18O.corrected) 
head(dfsml)
#Prepare for interpolation 
colnames(dfsml)<-c("x", "y","z") ; str(dfsml)
dfsml$x<-as.numeric(paste(dfsml$x))
dfsml$y<-as.numeric(paste(dfsml$y));str(dfsml)
x<-as.numeric(paste(dfsml$x))
y<-as.numeric(paste(dfsml$y))
z<-dfsml$z
sample=as.data.frame(cbind(x,y,z))
names(sample) <- c("d", "m", "value")
d1 <- with(sample, interp(x = d, y = m, z = value, nx = 250, ny=250, duplicate = "mean", extrap=FALSE))
d2 <- melt(d1$z, na.rm = TRUE)
names(d2) <- c("x", "y", "z")
d2$d<- d1$x[d2$x]
d2$m <- d1$y[d2$y]
#Plot 
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))

a<-ggplot(data = d2, aes(x = d, y = m, fill = z, z = z)) + 
  geom_tile()+  
  scale_fill_gradientn(colours = jet.colors(7), limits =c(-20,-8))+
  labs(x="Hour", y="Day")+
  labs(fill=bquote(delta^18*O))+
  ggtitle((a)~delta^18*O~Atmospheric~Water~Vapour)+
  theme_bw()+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='right') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 62, ymax = 67, alpha = 1)+
  theme(plot.title = element_text(size = 13.5, face = "bold"))+
  annotation_custom(textGrob("*", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-0.15, xmax=-1,ymin=55.5, ymax=56.5) +
  annotation_custom(textGrob("**", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-0.15, xmax=-1,ymin=82.5, ymax=83.5)   +
  guides(fill=guide_colourbar(barwdith=0.5, barheight =18, nbin=100)) +
  theme(plot.title = element_text(size = 20, face = "bold"))
a
```

#(b) The Code is almost identical just changing treatment
```{r}
dftrt<-data.frame(df$hm, df$month, df$d18O.corrected, df$T_treatment, df$Td);str(dftrt)
dft<-dftrt %>% group_by(df.T_treatment, df.Td) %>% summarise_at(.vars = names(.)[3:3], na.rm=TRUE, .funs = c(mean))
dft<-subset(dft,df.T_treatment == "ambient")# HERE IS THE CHANGE TO AMBIENT DATA
dft$date <- as.Date(dft$df.Td, format = "%Y-%m-%d") 
dft["month"]<-format(dft$df.Td,"%m");str(dft$month);summary(dft$month)
dft["monthday"]<-format(dft$df.Td,"%m%d");str(dft$monthday);summary(dft$monthday)
dft<-transform(dft,day=as.numeric(factor(monthday))) #day
dft<-as.data.frame(dft)
dft$hm <- format(dft$df.Td, "%H") ; summary(dft$hm)
dfsml<-data.frame(dft$hm, dft$day, dft$df.d18O.corrected) 
colnames(dfsml)<-c("x", "y","z") ; str(dfsml)
dfsml$x<-as.numeric(paste(dfsml$x))
dfsml$y<-as.numeric(paste(dfsml$y));str(dfsml)
x<-as.numeric(paste(dfsml$x))
y<-as.numeric(paste(dfsml$y))
z<-dfsml$z
sample=as.data.frame(cbind(x,y,z))
names(sample) <- c("d", "m", "value")
d1 <- with(sample, interp(x = d, y = m, z = value, nx = 250, ny=250, duplicate = "mean", extrap=FALSE))
d2 <- melt(d1$z, na.rm = TRUE)
names(d2) <- c("x", "y", "z")
d2$d<- d1$x[d2$x]
d2$m <- d1$y[d2$y]
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
b<-ggplot(data = d2, aes(x = d, y = m, fill = z, z = z)) + 
  geom_tile()+  
  scale_fill_gradientn(colours = jet.colors(7), limits =c(-20,-8))+
  labs(x="Hour", y="Day")+
  labs(fill=bquote(delta^18*O))+
  ggtitle((b)~delta^18*O~Chamber~Water~Vapour)+
  theme_bw()+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='right') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 62, ymax = 67, alpha = 1)+
  theme(plot.title = element_text(size = 13.5, face = "bold"))+
  annotation_custom(textGrob("*", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-0.15, xmax=-1,ymin=55.5, ymax=56.5) +
  annotation_custom(textGrob("**", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-0.15, xmax=-1,ymin=82.5, ymax=83.5)  +
  guides(fill=guide_colourbar(barwdith=0.5, barheight =18, nbin=100))+
  theme(plot.title = element_text(size = 20, face = "bold"))
b

```

#(c) is the same again but we use the elevated data
```{r}
dftrt<-data.frame(df$hm, df$month, df$d18O.corrected, df$T_treatment, df$Td);str(dftrt)
dft<-dftrt %>% group_by(df.T_treatment, df.Td) %>% summarise_at(.vars = names(.)[3:3], na.rm=TRUE, .funs = c(mean))
dft<-subset(dft,df.T_treatment == "elevated") #Here we change to eleveted data
dft$date <- as.Date(dft$df.Td, format = "%Y-%m-%d") 
dft["month"]<-format(dft$df.Td,"%m");str(dft$month);summary(dft$month)
dft["monthday"]<-format(dft$df.Td,"%m%d");str(dft$monthday);summary(dft$monthday)
dft<-transform(dft,day=as.numeric(factor(monthday))) #day
dft<-as.data.frame(dft)
dft$hm <- format(dft$df.Td, "%H") ; summary(dft$hm)
dfsml<-data.frame(dft$hm, dft$day, dft$df.d18O.corrected)
colnames(dfsml)<-c("x", "y","z") ; str(dfsml)
dfsml$x<-as.numeric(paste(dfsml$x))
dfsml$y<-as.numeric(paste(dfsml$y));str(dfsml)
x<-as.numeric(paste(dfsml$x))
y<-as.numeric(paste(dfsml$y))
z<-dfsml$z
sample=as.data.frame(cbind(x,y,z))
names(sample) <- c("d", "m", "value")
d1 <- with(sample, interp(x = d, y = m, z = value, nx = 250, ny=250, duplicate = "mean", extrap=FALSE))
d2 <- melt(d1$z, na.rm = TRUE)
names(d2) <- c("x", "y", "z")
d2$d<- d1$x[d2$x]
d2$m <- d1$y[d2$y]
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
c<-ggplot(data = d2, aes(x = d, y = m, fill = z, z = z)) + 
  geom_tile()+  
  scale_fill_gradientn(colours = jet.colors(7), limits =c(-20,-8))+
  labs(x="Hour", y="Day")+
  labs(fill=bquote(delta^18*O))+
  ggtitle((c)~delta^18*O~Chamber~Water~Vapour)+
  theme_bw()+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='right') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 62, ymax = 67, alpha = 1)+
  theme(plot.title = element_text(size = 13.5, face = "bold"))+
  annotation_custom(textGrob("*", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-0.15, xmax=-1,ymin=55.5, ymax=56.5) +
  annotation_custom(textGrob("**", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-0.15, xmax=-1,ymin=82.5, ymax=83.5)  +
  guides(fill=guide_colourbar(barwdith=0.5, barheight =18, nbin=100))+
  theme(plot.title = element_text(size = 20, face = "bold"))
c
```
#(d) same concept as d18O but we change to temperture
#Here I use a different dataframe (I later merge parts of this data frame with wind and rain data to run multiple regression )
#This data set is massive ~100mb and has all the WTC4 data (not just when the isotope laser was running)

#we later need a,b,c these are ggplot objects that form the stacked graph, but we can clear everything else 
```{r}
keep(a,b,c, sure = TRUE)
```

```{r}
googledriveWTC4FLUXDATAFORHEATMAP <- "138BezZPxsWQ-LIqYP7szE36JeYAY0V-q"
df<- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", googledriveWTC4FLUXDATAFORHEATMAP)) #best to load this in andthe # it out
df$esat<-esat(TdegC=df$Tair_al, Pa = 101)
df$vpd<-RHtoVPD(RH=df$RH_al, TdegC=df$Tair_al, Pa = 101) ; summary(df$vpd) #the vapour pr
df["Td"]<-(ymd_hms(df$DateTime, quiet=TRUE, tz="UTC"));summary(df$Td)
df$date <- as.Date(df$Td, format = "%Y-%m-%d") ; summary(df$date); str(df$date)
df["month"]<-format(df$Td,"%m");str(df$month)
df$hm <- format(df$Td, "%H") ; summary(df$hm)
df["week"]<-strftime(df$Td,format="%W",tz="UTC");str(df$week)
df<-distinct(df)
start<-ymd_hms("2016-08-28 12:00:00 UTC");summary(start)
end<-ymd_hms("2016-11-26 12:00:00")
int<-interval(start, end); summary(int)
df<-subset(df, df$Td %within% int);head(df$Td);tail(df$Td)
#not that here we use Taref_al this is the reference (outside//ambient) air
dftrt<-data.frame(df$hm, df$month, df$Taref_al, df$T_treatment, df$Td);str(dftrt)
dft<-dftrt %>% group_by(df.T_treatment, df.Td) %>% summarise_at(.vars = names(.)[3:3], na.rm=TRUE, .funs = c(mean))
dft<-subset(dft,df.T_treatment == "ambient")
dft$date <- as.Date(dft$df.Td, format = "%Y-%m-%d") 
dft["month"]<-format(dft$df.Td,"%m");str(dft$month);summary(dft$month)
dft["monthday"]<-format(dft$df.Td,"%m%d");str(dft$monthday);summary(dft$monthday)
dft<-transform(dft,day=as.numeric(factor(monthday))) #day
dft<-as.data.frame(dft)
dft$hm <- format(dft$df.Td, "%H") ; summary(dft$hm)
dfsml<-data.frame(dft$hm, dft$day, dft$df.Taref_al) 
colnames(dfsml)<-c("x", "y","z") ; str(dfsml)
dfsml$x<-as.numeric(paste(dfsml$x))
dfsml$y<-as.numeric(paste(dfsml$y));str(dfsml)
x<-as.numeric(paste(dfsml$x))
y<-as.numeric(paste(dfsml$y))
z<-dfsml$z
gdf<-as.data.frame(cbind(x,y,z))
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
d<-ggplot(gdf, aes(x, y, fill=z)) + 
  geom_raster(interpolate = TRUE) + 
  scale_fill_gradientn(colours = jet.colors(7), limits =c(0, 45))+
  labs(x="Hour", y="Day")+
  labs(fill=("?C"))+
  ggtitle((d)~Atmospheric~Air~Temperature)+
  theme_bw()+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='right') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 62, ymax = 67, alpha = 1)+
  theme(plot.title = element_text(size = 13.5, face = "bold"))+
  annotation_custom(textGrob("*", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=55.5, ymax=56.5) +
  annotation_custom(textGrob("**", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=82.5, ymax=83.5) +
  guides(fill=guide_colourbar(barwdith=0.5, barheight =18, nbin=100)) +
  theme(plot.title = element_text(size = 20, face = "bold"))
d
```
#(e) is the same but we change from reference air temp to chamber air temp

```{r}
#Note that we use Tair_al now -- this is in chamber air temp
dftrt<-data.frame(df$hm, df$month, df$Tair_al, df$T_treatment, df$Td);str(dftrt)
dft<-dftrt %>% group_by(df.T_treatment, df.Td) %>% summarise_at(.vars = names(.)[3:3], na.rm=TRUE, .funs = c(mean))
dft<-subset(dft,df.T_treatment == "ambient")
dft$date <- as.Date(dft$df.Td, format = "%Y-%m-%d") 
dft["month"]<-format(dft$df.Td,"%m");str(dft$month);summary(dft$month)
dft["monthday"]<-format(dft$df.Td,"%m%d");str(dft$monthday);summary(dft$monthday)
dft<-transform(dft,day=as.numeric(factor(monthday))) #day
dft<-as.data.frame(dft)
dft$hm <- format(dft$df.Td, "%H") ; summary(dft$hm)
dfsml<-data.frame(dft$hm, dft$day, dft$df.Tair_al) #Temp ref 
colnames(dfsml)<-c("x", "y","z") ; str(dfsml)
dfsml$x<-as.numeric(paste(dfsml$x))
dfsml$y<-as.numeric(paste(dfsml$y));str(dfsml)
x<-as.numeric(paste(dfsml$x))
y<-as.numeric(paste(dfsml$y))
z<-dfsml$z
gdf<-as.data.frame(cbind(x,y,z))
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
e<-ggplot(gdf, aes(x, y, fill=z)) + 
  geom_raster(interpolate = TRUE) + 
  scale_fill_gradientn(colours = jet.colors(7), limits =c(0, 45))+
  labs(x="Hour", y="Day")+
  labs(fill=("?C"))+
  ggtitle((e)~Chamber~Air~Temperature)+
  theme_bw()+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='right') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 62, ymax = 67, alpha = 1)+
  theme(plot.title = element_text(size = 13.5, face = "bold"))+
  annotation_custom(textGrob("*", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=55.5, ymax=56.5) +
  annotation_custom(textGrob("**", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=82.5, ymax=83.5)+
  guides(fill=guide_colourbar(barwdith=0.5, barheight =18, nbin=100))+
  theme(plot.title = element_text(size = 20, face = "bold"))
e
```
#(f) is again the same but switch to eleveted data
```{r}
dftrt<-data.frame(df$hm, df$month, df$Tair_al, df$T_treatment, df$Td);str(dftrt)
dft<-dftrt %>% group_by(df.T_treatment, df.Td) %>% summarise_at(.vars = names(.)[3:3], na.rm=TRUE, .funs = c(mean))
dft<-subset(dft,df.T_treatment == "elevated")
dft$date <- as.Date(dft$df.Td, format = "%Y-%m-%d") 
dft["month"]<-format(dft$df.Td,"%m");str(dft$month);summary(dft$month)
dft["monthday"]<-format(dft$df.Td,"%m%d");str(dft$monthday);summary(dft$monthday)
dft<-transform(dft,day=as.numeric(factor(monthday))) #day
dft<-as.data.frame(dft)
dft$hm <- format(dft$df.Td, "%H") ; summary(dft$hm)
dfsml<-data.frame(dft$hm, dft$day, dft$df.Tair_al) 
colnames(dfsml)<-c("x", "y","z") ; str(dfsml)
dfsml$x<-as.numeric(paste(dfsml$x))
dfsml$y<-as.numeric(paste(dfsml$y));str(dfsml)
x<-as.numeric(paste(dfsml$x))
y<-as.numeric(paste(dfsml$y))
z<-dfsml$z
gdf<-as.data.frame(cbind(x,y,z))
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
f<-ggplot(gdf, aes(x, y, fill=z)) + 
  geom_raster(interpolate = TRUE) + 
  scale_fill_gradientn(colours = jet.colors(7), limits =c(0, 45))+
  labs(x="Hour", y="Day")+
  labs(fill=("?C"))+
  ggtitle((f)~Chamber~Air~Temperature)+
  theme_bw()+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='right') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 62, ymax = 67, alpha = 1)+
  theme(plot.title = element_text(size = 13.5, face = "bold"))+
  annotation_custom(textGrob("*", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=55.5, ymax=56.5) +
  annotation_custom(textGrob("**", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=82.5, ymax=83.5)   +
  guides(fill=guide_colourbar(barwdith=0.5, barheight =18, nbin=100))+
  theme(plot.title = element_text(size = 20, face = "bold"))
f
```
#(g) We use the same data frame to make the VPD plots
```{r}
##note we calculate VPD with Reference RH and Temp
df$vpd<-RHtoVPD(RH=df$RHref_al, TdegC=df$Taref_al, Pa = 101) ;summary(df$vpd) 
dftrt<-data.frame(df$hm, df$month, df$vpd, df$T_treatment, df$Td);str(dftrt)
dft<-dftrt %>% group_by(df.T_treatment, df.Td) %>% summarise_at(.vars = names(.)[3:3], na.rm=TRUE, .funs = c(mean))
dft<-subset(dft,df.T_treatment == "ambient")
dft$date <- as.Date(dft$df.Td, format = "%Y-%m-%d") 
dft["month"]<-format(dft$df.Td,"%m");str(dft$month);summary(dft$month)
dft["monthday"]<-format(dft$df.Td,"%m%d");str(dft$monthday);summary(dft$monthday)
dft<-transform(dft,day=as.numeric(factor(monthday))) #day
dft<-as.data.frame(dft)
dft$hm <- format(dft$df.Td, "%H") ; summary(dft$hm)
dfsml<-data.frame(dft$hm, dft$day, dft$df.vpd) 
colnames(dfsml)<-c("x", "y","z") ; str(dfsml)
dfsml$x<-as.numeric(paste(dfsml$x))
dfsml$y<-as.numeric(paste(dfsml$y));str(dfsml)
x<-as.numeric(paste(dfsml$x))
y<-as.numeric(paste(dfsml$y))
z<-dfsml$z
gdf<-as.data.frame(cbind(x,y,z))
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
g<-ggplot(gdf, aes(x, y, fill=z)) + 
  geom_raster(interpolate = TRUE) + 
  scale_fill_gradientn(colours = jet.colors(7), limits =c(0.03, 4.8))+
  labs(x="Hour", y="Day")+
  labs(fill=("kPa"))+
  ggtitle((g)~Atmospheric~VPD)+
  theme_bw()+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='right') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 62, ymax = 67, alpha = 1)+
  theme(plot.title = element_text(size = 13.5, face = "bold"))+
  annotation_custom(textGrob("*", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=55.5, ymax=56.5) +
  annotation_custom(textGrob("**", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=82.5, ymax=83.5)  +
  guides(fill=guide_colourbar(barwdith=0.5, barheight =18, nbin=100))+
  theme(plot.title = element_text(size = 20, face = "bold"))
g
```
#(h) again we just switch from reference to chamber 

```{r}
##Note we switch to in chamber measurements
df$vpd<-RHtoVPD(RH=df$RH_al, TdegC=df$Tair_al, Pa = 101) ; summary(df$vpd) #the vapour pr
dftrt<-data.frame(df$hm, df$month, df$vpd, df$T_treatment, df$Td);str(dftrt)
dft<-dftrt %>% group_by(df.T_treatment, df.Td) %>% summarise_at(.vars = names(.)[3:3], na.rm=TRUE, .funs = c(mean))
dft<-subset(dft,df.T_treatment == "ambient")
dft$date <- as.Date(dft$df.Td, format = "%Y-%m-%d") 
dft["month"]<-format(dft$df.Td,"%m");str(dft$month);summary(dft$month)
dft["monthday"]<-format(dft$df.Td,"%m%d");str(dft$monthday);summary(dft$monthday)
dft<-transform(dft,day=as.numeric(factor(monthday))) #day
dft<-as.data.frame(dft)
dft$hm <- format(dft$df.Td, "%H") ; summary(dft$hm)
dfsml<-data.frame(dft$hm, dft$day, dft$df.vpd) 
write.table(dft,"clipboard-16384", sep="\t", row.names=FALSE)
colnames(dfsml)<-c("x", "y","z") ; str(dfsml)
dfsml$x<-as.numeric(paste(dfsml$x))
dfsml$y<-as.numeric(paste(dfsml$y));str(dfsml)
x<-as.numeric(paste(dfsml$x))
y<-as.numeric(paste(dfsml$y))
z<-dfsml$z
gdf<-as.data.frame(cbind(x,y,z))
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
h<-ggplot(gdf, aes(x, y, fill=z)) + 
  geom_raster(interpolate = TRUE) + 
  scale_fill_gradientn(colours = jet.colors(7), limits =c(0.03, 4.8))+
  labs(x="Hour", y="Day")+
  labs(fill=("kPa"))+
  ggtitle((h)~Chamber~Vapour~Pressure~Defecit)+
  theme_bw()+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='right') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 62, ymax = 67, alpha = 1)+
  theme(plot.title = element_text(size = 13.5, face = "bold"))+
  annotation_custom(textGrob("*", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=55.5, ymax=56.5) +
  annotation_custom(textGrob("**", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=82.5, ymax=83.5)+
  guides(fill=guide_colourbar(barwdith=0.5, barheight =18, nbin=100))  +
  theme(plot.title = element_text(size = 20, face = "bold"))
h
```
#(i) as above but for eleveted data

```{r}
df$vpd<-RHtoVPD(RH=df$RH_al, TdegC=df$Tair_al, Pa = 101) ;summary(df$vpd) #the vapour pr
dftrt<-data.frame(df$hm, df$month, df$vpd, df$T_treatment, df$Td);str(dftrt)
dft<-dftrt %>% group_by(df.T_treatment, df.Td) %>% summarise_at(.vars = names(.)[3:3], na.rm=TRUE, .funs = c(mean))
dft<-subset(dft,df.T_treatment == "elevated")
dft$date <- as.Date(dft$df.Td, format = "%Y-%m-%d") 
dft["month"]<-format(dft$df.Td,"%m");str(dft$month);summary(dft$month)
dft["monthday"]<-format(dft$df.Td,"%m%d");str(dft$monthday);summary(dft$monthday)
dft<-transform(dft,day=as.numeric(factor(monthday))) #day
dft<-as.data.frame(dft)
dft$hm <- format(dft$df.Td, "%H") ; summary(dft$hm)
dfsml<-data.frame(dft$hm, dft$day, dft$df.vpd) 
write.table(dft,"clipboard-16384", sep="\t", row.names=FALSE)
colnames(dfsml)<-c("x", "y","z") ; str(dfsml)
dfsml$x<-as.numeric(paste(dfsml$x))
dfsml$y<-as.numeric(paste(dfsml$y));str(dfsml)
x<-as.numeric(paste(dfsml$x))
y<-as.numeric(paste(dfsml$y))
z<-dfsml$z
gdf<-as.data.frame(cbind(x,y,z))
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"))
i<-ggplot(gdf, aes(x, y, fill=z)) + 
  geom_raster(interpolate = TRUE) + 
  scale_fill_gradientn(colours = jet.colors(7), limits =c(0.03, 4.8))+
  labs(x="Hour", y="Day")+
  labs(fill=("kPa"))+
  ggtitle((i)~Chamber~VPD)+
  theme_bw()+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='right') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 62, ymax = 67, alpha = 1)+
  theme(plot.title = element_text(size = 13.5, face = "bold"))+
  annotation_custom(textGrob("*", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=55.5, ymax=56.5) +
  annotation_custom(textGrob("**", gp = gpar(col = "black", fontsize=20)), 
                    xmin=-1.1, xmax=-0.8,ymin=82.5, ymax=83.5)  +
  guides(fill=guide_colourbar(barwdith=0.5, barheight =18, nbin=100))+
  theme(plot.title = element_text(size = 20, face = "bold"))
i
```

#TO finish figure 2 we need to merge all the panels
```{r}
plotmash<-plot_grid(a,b,c,d,e,f,g,h,i, nrow=3,ncol=3, align="vh")
title <- ggdraw() + 
  draw_label(
    "                                                                                                   Ambient Chambers                                                                Elevated Chambers",
    fontface = 'bold', 
    x = 0,
    hjust = 0,
    size=20
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )


figtemporal=plot_grid(
  title, plotmash,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.05, 1)
)
#Set your working directory (UNHASH)
#setwd("D:/WTC4 Data/new temporal graph")
#UNHASH below and it saves a HQ tiff 
ggsave("dayinterpHQstar.tiff", width = 50, height = 50, units = "cm", dpi=600)

```

```{r, fig.width = 40,fig.height=40} 
plot(figtemporal)
```


#The rest of the figures use the campaign data- they all depend on the mass balance being run
#Here is the Mass Balance code which uses the campaign data. Firstly lets clear the workspace

```{r}
rm(list = ls())
```

#Mass Balance (used to calculate d18otranspiration)

```{r}


googledriveWTC4ISOTOPEIDCAMPAIGNDATA <- "1_K_m1eq-iQGQmOC3hqoI7_8qxVve3YoB"
df<- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", googledriveWTC4ISOTOPEIDCAMPAIGNDATA))
######
df["source"]=-3.28 ##from branch water
###
R<-287.05
Rv<-461.95
Pr<-101.3
finr<-0.082058
##These equations are a combo of the WTC4 MS, John Drakes GBC Biology and Craigs orginal WTC4 Agmet paper
####Pref###
df["Pref"]=((df$AIRPRESS_mean*1000)-df$Vwat_mean)/(R*(df$Tair_al_mean+273))+((df$Vwat_mean)/(Rv*df$Vwat_mean+273))
####Fin####
df["fin"]=(df$kfactor_mean*(sqrt(df$DIFFP_mean*(1.2/df$Pref)))*(273/(df$Tair_al_mean+273))*(df$AIRPRESS_mean/Pr))
###Finmol###
df["finmol"]=((df$AIRPRESS_mean*0.00986923267)*df$fin)/(finr*(df$Tair_al_mean+273))
##fout###
df["fout"]=df$fin*(((df$AIRPRESS_mean)-df$Href_mean)/((df$Tair_al_mean)-df$Href_mean))
##fout mol
df["foutmol"]=((df$AIRPRESS_mean*0.00986923267)*df$fout)/(finr*(df$Tair_al_mean+273))
#uoutwout
df["uoutwout"]=df$foutmol*df$Vwat_mean
#uinwin
df["uinwin"]=df$finmol*df$Fwat_mean
#condout
df["condout"]=df$CONDH2O_mean
##E
df["E"]=df$uoutwout-df$uinwin+df$condout
##E-wo
df["e-wo"]=df$E-df$Vwat_mean
##d18out
df["d18out"]=df$d18O.corrected_WV*df$uoutwout
#d18in
df["d18in"]=df$d18O.corrected_WV.AMB.*df$uinwin
##d18c
df["d18c"]=df$d18O.corrected_Cond*df$condout
##over e-wo
df["d18oute"]=df$d18out/df$`e-wo` ;df["d18ine"]=df$d18in/df$`e-wo`; df["d18Ce"]=df$d18c/df$E
##d trans
df["dtrans"]=df$d18oute-df$d18ine+df$d18Ce ; mean(df$dtrans, na.rm = TRUE ) ;df$dtrans
#We need to express mulriple variables on a leaf area basis: 
df$leafarea[df$chamber=="C01"]<-23.62101328 #M^2
df$leafarea[df$chamber=="C02"]<- 17.17025483
df$leafarea[df$chamber=="C03"]<- 12.37672299
df$leafarea[df$chamber=="C04"]<-24.62392584
df$leafarea[df$chamber=="C05"]<- 12.92316481
df$leafarea[df$chamber=="C06"]<-29.71035506
df$leafarea[df$chamber=="C07"]<- 14.61233375
df$leafarea[df$chamber=="C08"]<- 24.42841037
df$leafarea[df$chamber=="C09"]<- 17.33770004
df$leafarea[df$chamber=="C10"]<- 17.13905693
df$leafarea[df$chamber=="C11"]<- 9.63132978
df$leafarea[df$chamber=="C12"]<- 27.27409398
df$LACM<-df$leafarea / 10000
#leaf water turnover = W/gt*wi
#wi is the leaf intercellular vapour concentration (mol water vapour/mol moist air)
#using Licor eqn  mole fraction of water vapor within the leaf, mmol H2O mol air-1.
df["Ei"]<-6.13753*exp(df$leaftemp*((18.564-(df$leaftemp/254.4)))/(df$leaftemp+255.57))
df$wi<-df$Ei / df$AIRPRESS_mean/10  #mol mol -1
##make E a flux relative to tree lef area
df$Emmol<-df$E*1000 #go to mmol
df$Eleaf<-df$Emmol/df$leafarea ; plot(df$Eleaf) #(mmol H2O m-2 s-1)
##Calculate VPD
df$esat<-esat(TdegC=df$Tair_al_mean, Pa = 101)
df$vpd<-RHtoVPD(RH=df$RH_al_mean, TdegC=df$Tair_al_mean, Pa = 101) ; plot(df$vpd);summary(df$vpd) #the vapour pressure deficit of the chamber airspace (kPa)
##Calculate gt -gt is total conductance to water vapour through the stomata and leaf boundary layer
df$gs<-df$Eleaf/df$vpd/10 # mol
#####################################
##Calculate Leaf Water Residence Times##
df$W<- 12 #mol m-2
df$t<-df$W/(df$gs*df$wi) # in seconds
df$tm<-df$t/60 ;mean(df$tm, na.rm=TRUE);min(df$tm, na.rm=TRUE);max(df$tm, na.rm=TRUE) # T in mins
df$th<-df$t/3600 ;mean(df$th, na.rm=TRUE);min(df$th, na.rm=TRUE);max(df$th, na.rm=TRUE) # T in hour
###Calculate for isotopes
df$ek=0.027
df$alphak<-1+df$ek
df["Eplus"]<-2.644-(3.206*((10^3)/(df$Tair_al_mean+273.16)))+(1.534*((10^6)/((df$Tair_al_mean+273.16)^2)))
df$betaplus<-(df$Eplus/1000)+ 1
mean(df$alphak*df$betaplus)
df$p<-1.2 ##See SI from MS
##df$alphak*df$betaplus shold be around 1.040 (Table 1 Grahams and Lucas paper)
df$tiso<-(df$W*df$alphak*df$betaplus)/(df$p*df$gs*df$wi)
df$tmiso<-df$tiso/60 ;mean(df$tmiso, na.rm=TRUE);min(df$tmiso, na.rm=TRUE);max(df$tmiso, na.rm=TRUE) # T in mins
df$thiso<-df$tiso/3600 ;mean(df$thiso, na.rm=TRUE);min(df$thiso, na.rm=TRUE);max(df$thiso, na.rm=TRUE)
###calculate number obsertavtions of dtrans within 2 mil
df$range<-ifelse(df$dtrans  >= -5.28 & df$dtrans <= -1.28, "within", "not");df$range<-as.factor(df$range)
summary(df$range) # 107 not in 264 within = 367 total % witin 2 % is 258 /367
264/(264+107) #~70% 
##get chamber %
tapply(df$range, df$chamber, summary)
##The following lines of code define when chamber air temp and chamber dew point temp are within 1C or negative
#We need to figure out if Dew Point deltas could be influecing gs
df$dpdiffwtc<-df$Tair_al-df$DewPntC;df$dpdiffwtc 
#the below statement defines which observations are with or not within 1 or negative
df$rangewtc<-ifelse(df$dpdiffwtc  >= -1000000 & df$dpdiffwtc<= 1, "not", "within");df$rangewtc<-as.factor(df$rangewtc) #t
summary(df$rangewtc) # 80 not in 520 within 
#Count how many data points are comprimised from each treatment
sub<- df[df$trt == "ambient",] ;summary(sub$rangewtc) # 80 outisde out of 220 ambineto observatins or 36 % 
subx<- df[df$trt == "elevated ",] ;summary(subx$rangewtc) # 0 
##If we run teh scirpt with dew point difference we ommit amy values that are less then 1
df$sun<- ifelse(df$PAR >=0.01, "day", "night")
dfsun<-filter(df, df$sun == "day")
dfnight<-filter(df, df$sun == "night")
dfsun<-subset(dfsun, dtrans >-8 & dtrans<2) ## rhis just removes a few absurd values
#Calculate and export daily means 
dfsunmean<-dfsun[,c("trt","Camp","d18O.corrected_WV","d18O.corrected_WV.AMB.","dtrans" )]
#We can then caluclate the daily mean to compare to source 
x<-summaryBy(.~trt+Camp,FUN=c(mean,sd),keep.names=T,data=dfsunmean,na.rm=TRUE);max(dfsun$dtrans,na.rm=TRUE);x
#all close to source ~1 mil
write.table(x, "clipboard-16384", sep="\t", row.names=FALSE) ## this copies a table of mean daytime campaignvalues
#and below gets the atmsopheric d180
atmx<-summaryBy(.~Camp,FUN=c(mean,sd),keep.names=T,data=dfsunmean,na.rm=TRUE);max(dfsun$dtrans,na.rm=TRUE);atmx
##I make dfa to use in the code which makes Figures 2,3 and 4- These scripts will cal for WTC4 Ispflux model to be run
dfa<-df 
```
#Now that the mass balance is done and we have dfa (our campaign data -data frame) we can graph:
#To make the graphs we calcuate the mean and std error for each treatment and each campaign.
#again it is somewhat repetetive making each panel, just changing variables adn when neccasry highlighting which variables
#have dew point and air temp to close
#Here is temperture 1= first campaign , 3 = 3rd campaign. there was a 2nd campaign but the LGR was down (blacked out area fig2)
```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)

Cw <- Cw[,c("rangewtc","Tdh","chamber","trt","Tair_al_mean")]
Trtmean<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cw)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[,c("rangewtc","Tdh","chamber","trt","Tair_al_mean")]
Trtmeanx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cwx)
#Trtmeanx<-filter(Trtmeanx, !grepl('<NA>', trt ))
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")
start2 = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end2 = as.POSIXct('2016-11-21 07:00:00', tz="UTC")

t1<-ggplot(data=data, aes(x=Time, y=Tair_al_mean))+
  geom_point(aes(colour=trt, shape=trt), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,16))+
  geom_errorbar(aes(ymin=Tair_al_mean-Tair_al_mean.1, ymax=Tair_al_mean+Tair_al_mean.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 40))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))

t1

t3<-ggplot(data=data2, aes(x=Time, y=Tair_al_mean))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,16))+
  geom_errorbar(aes(ymin=Tair_al_mean-Tair_al_mean.1, ymax=Tair_al_mean+Tair_al_mean.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 40))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
t3
```
#now VPD
```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)

Cw <- Cw[,c("Tdh","chamber","trt","vpd")]
Trtmean<- summaryBy(.~Tdh+trt,FUN=c(mean),keep.names=T,data=Cw)
#Trtmean<-filter(Trtmean, !grepl('<NA>', trt ));str(Trtmean)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trtc,FUN=c(se),keep.names=T,data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[,c("Tdh","chamber","trt","vpd")]
Trtmeanx<- summaryBy(.~Tdh+trt,FUN=c(mean),keep.names=T,data=Cwx)
#Trtmeanx<-filter(Trtmeanx, !grepl('<NA>', trt ))
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+trt,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")
start2 = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end2 = as.POSIXct('2016-11-21 07:00:00', tz="UTC")
vp1<-ggplot(data=data, aes(x=Time, y=vpd))+
  geom_point(aes(colour=trt, shape=trt), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c(16,16))+
  geom_errorbar(aes(ymin=vpd-vpd.1, ymax=vpd+vpd.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 3.5))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
vp1

vp3<-ggplot(data=data2, aes(x=Time, y=vpd))+
  geom_point(aes(colour=trt, shape=trt), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,16))+
  geom_errorbar(aes(ymin=vpd-vpd.1, ymax=vpd+vpd.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 3.5))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
vp3
```
#now Transpiration - here we need to denote which values are comprised (dew point close to air temp) with a *

```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)

Cw <- Cw[,c("rangewtc","Tdh","chamber","trt","Eleaf")]
Trtmean<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cw)
#Trtmean<-filter(Trtmean, !grepl('<NA>', trt ));str(Trtmean)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[,c("rangewtc","Tdh","chamber","trt","Eleaf")]
Trtmeanx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cwx)
#Trtmeanx<-filter(Trtmeanx, !grepl('<NA>', trt ))
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")
start2 = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end2 = as.POSIXct('2016-11-21 07:00:00', tz="UTC")
E1<-ggplot(data=data, aes(x=Time, y=Eleaf))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=Eleaf-Eleaf.1, ymax=Eleaf+Eleaf.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 3))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
E1

E3<-ggplot(data=data2, aes(x=Time, y=Eleaf))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+
  
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=Eleaf-Eleaf.1, ymax=Eleaf+Eleaf.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 3))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))

E3

```

#and lastly gs (again with *'s) night time gs should not be that high
```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)

Cw <- Cw[,c("rangewtc","Tdh","chamber","trt","gs")]
Trtmean<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,na.rm=TRUE,data=Cw)
#Trtmean<-filter(Trtmean, !grepl('<NA>', trt ));str(Trtmean)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[,c("rangewtc","Tdh","chamber","trt","gs")]
Trtmeanx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,na.rm=TRUE,data=Cwx)
#Trtmeanx<-filter(Trtmeanx, !grepl('<NA>', trt ))
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")
start2 = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end2 = as.POSIXct('2016-11-21 07:00:00', tz="UTC")

gs1<-ggplot(data=data, aes(x=Time, y=gs))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=gs-gs.1, ymax=gs+gs.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 0.3))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
gs1


gs3<-ggplot(data=data2, aes(x=Time, y=gs))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+
  
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=gs-gs.1, ymax=gs+gs.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 0.3))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
gs3
```
#We now just merge these diel obsevrations into one big figure 

```{r}
##FIgure 2 enviro vars
Figure2=plot_grid(t1,t3,vp1,vp3,E1,E3,gs1,gs3,  ncol = 2, align = 'hv')
#and then ggsave it out -- I added axis labels etc later in adobe illustator 
```


```{r, fig.width = 40,fig.height=40} 
plot(Figure2)
```
#We continue with dfa to make the next figure (but we can clean the environment again)
```{r}
keep(dfa, sure = TRUE)
```

#Figure 4 starts with leaf water turnover time and isotipic leaf water turnover time
#the * filter is applied to all plots in Figure 4
```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)

Cw <- Cw[,c("rangewtc","Tdh","chamber","trt","th")]
Trtmean<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cw)
#Trtmean<-filter(Trtmean, !grepl('<NA>', trt ));str(Trtmean)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[,c("rangewtc","Tdh","chamber","trt","th")]
Trtmeanx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cwx)
#Trtmeanx<-filter(Trtmeanx, !grepl('<NA>', trt ))
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")
start2 = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end2 = as.POSIXct('2016-11-21 07:00:00', tz="UTC")
th1<-ggplot(data=data, aes(x=Time, y=th))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
   scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=th-th.1, ymax=th+th.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 20))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
th1

th3<-ggplot(data=data2, aes(x=Time, y=th))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+
  
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=th-th.1, ymax=th+th.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 20))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
th3
```
#as above but with isotopic leaf water turnover 
```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)

Cw <- Cw[,c("rangewtc","Tdh","chamber","trt","thiso")]
Trtmean<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cw)
#Trtmean<-filter(Trtmean, !grepl('<NA>', trt ));str(Trtmean)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[,c("rangewtc","Tdh","chamber","trt","thiso")]
Trtmeanx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cwx)
#Trtmeanx<-filter(Trtmeanx, !grepl('<NA>', trt ))
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")
start2 = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end2 = as.POSIXct('2016-11-21 07:00:00', tz="UTC")

thi1<-ggplot(data=data, aes(x=Time, y=thiso))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=thiso-thiso.1, ymax=thiso+thiso.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+

  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 20))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
thi1

thi3<-ggplot(data=data2, aes(x=Time, y=thiso))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+
   scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=-thiso-thiso.1, ymax=thiso+thiso.1), width=.2, position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),limits = c(0, 20))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
thi3
```
#the next panels differ slighlty in that d18oatm needs to be overlayed in black
#Here is campaign 1
```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)

Cw<-Cw[,c("rangewtc","Tdh","chamber","trt","d18O.corrected_WV")]
Trtmean<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cw)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 1)
Cwx <- Cwx[,c("Tdh","chamber","trt","d18O.corrected_WV.AMB.")]
Trtmeanx<- summaryBy(.~Tdh,FUN=c(mean),keep.names=T,data=Cwx)
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+chamber,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")

a<-ggplot(data=data, aes(x=Time, y=d18O.corrected_WV))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 

  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=d18O.corrected_WV-d18O.corrected_WV.1, ymax=d18O.corrected_WV+d18O.corrected_WV.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-15, -8))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
iso1<-a+geom_point(data = data2, mapping = 
             aes(x = Time, y = d18O.corrected_WV.AMB.),size=3,color="gray57")

iso1
```

#and campaign 2

```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 3)
Cw<-Cw[,c("rangewtc","Tdh","chamber","trt","d18O.corrected_WV")]
Trtmean<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,data=Cw)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[,c("Tdh","chamber","trt","d18O.corrected_WV.AMB.")]
Trtmeanx<- summaryBy(.~Tdh,FUN=c(mean),keep.names=T,data=Cwx)
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+chamber,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-11-21 07:00:00', tz="UTC")
aa<-ggplot(data=data, aes(x=Time, y=d18O.corrected_WV))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=d18O.corrected_WV-d18O.corrected_WV.1, ymax=d18O.corrected_WV+d18O.corrected_WV.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-15, -8))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))

iso3<-aa+geom_point(data = data2, mapping = 
               aes(x = Time, y = d18O.corrected_WV.AMB.),size=3,color="gray57")
iso3
```
#next we want to plot the chamber condensation 

```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)

Cw <- Cw[,c("rangewtc","Tdh","chamber","trt","d18O.corrected_Cond")]
Trtmean<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,na.rm=TRUE,data=Cw)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[,c("rangewtc","Tdh","chamber","trt","d18O.corrected_Cond")]
Trtmeanx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,na.rm=TRUE,data=Cwx)
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")
start2 = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end2 = as.POSIXct('2016-11-21 07:00:00', tz="UTC")
c1<-ggplot(data=data, aes(x=Time, y=d18O.corrected_Cond))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=d18O.corrected_Cond-d18O.corrected_Cond.1, ymax=d18O.corrected_Cond+d18O.corrected_Cond.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
c1

c3<-ggplot(data=data2, aes(x=Time, y=d18O.corrected_Cond))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=d18O.corrected_Cond-d18O.corrected_Cond.1, ymax=d18O.corrected_Cond+d18O.corrected_Cond.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))
c3

```

#lastly we plot d18otrans - the only change here is we shade +- 2 per mil 
```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)
Cw <- Cw[,c("rangewtc","Tdh","chamber","trt","dtrans")]
Trtmean<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,na.rm=TRUE,data=Cw)
se <- function(x) sqrt(var(x)/length(x))
Trtsd<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T, data=Cw)
data<-cbind(Trtmean,Trtsd);data<-as.data.frame(data)
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
#######################
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[,c("rangewtc","Tdh","chamber","trt","dtrans")]
Trtmeanx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(mean),keep.names=T,na.rm=TRUE,data=Cwx)
se <- function(x) sqrt(var(x)/length(x))
Trtsdx<- summaryBy(.~Tdh+trt+rangewtc,FUN=c(se),keep.names=T,data=Cwx)
data2<-cbind(Trtmeanx,Trtsdx);data2<-as.data.frame(data2)
data2['Time']<-(dmy_hm(data2$Tdh, quiet=TRUE, tz="UTC"));str(data)
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")
start2 = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end2 = as.POSIXct('2016-11-21 07:00:00', tz="UTC")
#shade within 2%
infa1<- as.POSIXct('2016-10-24 13:00:00"', tz="UTC") 
infb1<- as.POSIXct('2016-10-25 14:00:00"', tz="UTC")
infa<- as.POSIXct('2016-11-20 12:00:00"', tz="UTC") 
infb<- as.POSIXct('2016-11-21 11:00:00"', tz="UTC")

dt1<-ggplot(data=data, aes(x=Time, y=dtrans))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  annotate("rect", fill = "yellow", alpha = 0.15, 
           xmin = infa1, xmax = infb1,
           ymin = -5.28, ymax = -1.28)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=dtrans-dtrans.1, ymax=dtrans+dtrans.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))+
geom_hline(yintercept=-3.28, colour ="red", size=1.5) 
dt1

dt3<-ggplot(data=data2, aes(x=Time, y=dtrans))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+ 
  annotate("rect", fill = "yellow", alpha = 0.15, 
           xmin = infa, xmax = infb,
           ymin = -5.28, ymax = -1.28)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  geom_errorbar(aes(ymin=dtrans-dtrans.1, ymax=dtrans+dtrans.1), width=.2,
                position=position_dodge(.9))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=16, angle=45, hjust=1 , vjust=1))+
  geom_hline(yintercept=-3.28, colour ="red", size=1.5) 
dt3
```

#we finish by mergeing these panels into the figure 
```{r}
figure3=plot_grid(th1,th3,thi1,thi3,iso1,iso3,c1,c3,dt1,dt3,  ncol = 2, align = 'hv')
#again ggsave the figure out and annoated in illustator 
```
```{r, fig.width = 40,fig.height=40} 
plot(figure3)
```

###The same data makes figure S4
```{r}
wtc<-dfa
Cw<-wtc
Cw<-subset(Cw, Camp== 1)

Cw <- Cw[,c("rangewtc","Tdh","chamber","trt","dtrans")]
data=Cw
data['Time']<-(dmy_hm(data$Tdh, quiet=TRUE, tz="UTC"));str(data)
amb<- data[data$trt == "ambient",]  
hot<- data[data$trt == "elevated ",] 
Cwx<-wtc
Cwx<-subset(Cwx, Camp== 3)
Cwx <- Cwx[c("rangewtc","Tdh","chamber","trt","dtrans")]
datax=Cwx
datax['Time']<-(dmy_hm(datax$Tdh, quiet=TRUE, tz="UTC"));str(datax)
ambx<- datax[datax$trt == "ambient",]  
hotx<- datax[datax$trt == "elevated ",] 
start = as.POSIXct('2016-10-24 19:00:00"', tz="UTC") 
end = as.POSIXct('2016-10-25 07:00:00', tz="UTC")
start2 = as.POSIXct('2016-11-20 19:00:00"', tz="UTC") 
end2 = as.POSIXct('2016-11-21 07:00:00', tz="UTC")
#shade within 2%
infa1<- as.POSIXct('2016-10-24 13:00:00"', tz="UTC") 
infb1<- as.POSIXct('2016-10-25 14:00:00"', tz="UTC")
infa<- as.POSIXct('2016-11-20 12:00:00"', tz="UTC") 
infb<- as.POSIXct('2016-11-21 11:00:00"', tz="UTC")
a<-ggplot(data=amb, aes(x=Time, y=dtrans))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  annotate("rect", fill = "yellow", alpha = 0.15, 
           xmin = infa1, xmax = infb1,
           ymin = -5.28, ymax = -1.28)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=15, angle=45, hjust=1 , vjust=1),plot.margin = margin(10, 10, 10, 10))+
  geom_hline(yintercept=-3.28, colour ="red", size=1.5) +
  facet_wrap( ~ chamber, ncol=1)+ 
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )+ theme(panel.spacing = unit(1, "lines"))
a

b<-ggplot(data=ambx, aes(x=Time, y=dtrans))+
  geom_point(aes(colour=trt, shape=rangewtc), size=3.5,shape=16)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+
  annotate("rect", fill = "yellow", alpha = 0.15, 
           xmin = infa, xmax = infb,
           ymin = -5.28, ymax = -1.28)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=15, angle=45, hjust=1 , vjust=1),plot.margin = margin(10, 10, 10, 10))+
  geom_hline(yintercept=-3.28, colour ="red", size=1.5)+
  facet_wrap( ~ chamber, ncol=1)+ 
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )+ theme(panel.spacing = unit(1, "lines"))
b

c<-ggplot(data=hot, aes(x=Time, y=dtrans))+
  geom_point(aes(colour="red", shape=rangewtc), size=3.5,shape=16)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end, xmax = start,
           ymin = -Inf, ymax = Inf)+
  annotate("rect", fill = "yellow", alpha = 0.15, 
           xmin = infa1, xmax = infb1,
           ymin = -5.28, ymax = -1.28)+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=15, angle=45, hjust=1 , vjust=1),plot.margin = margin(10, 10, 10, 10))+
  geom_hline(yintercept=-3.28, colour ="red", size=1.5)+
  facet_wrap( ~ chamber, ncol=1)+ 
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )+ theme(panel.spacing = unit(1, "lines"))
c

d<-ggplot(data=hotx, aes(x=Time, y=dtrans))+
  geom_point(aes(colour="red"), size=3.5,)+ 
  annotate("rect", fill = "black", alpha = 0.15, 
           xmin = end2, xmax = start2,
           ymin = -Inf, ymax = Inf)+
  annotate("rect", fill = "yellow", alpha = 0.15, 
           xmin = infa, xmax = infb,
           ymin = -5.28, ymax = -1.28)+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(8,16))+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=15, angle=45, hjust=1 , vjust=1),plot.margin = margin(10, 10, 10, 10))+
  geom_hline(yintercept=-3.28, colour ="red", size=1.5)+  
  facet_wrap( ~ chamber, ncol=1)+ 
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )+ theme(panel.spacing = unit(1, "lines"))
d

figures4=cowplot::plot_grid(a,b,c,d,  ncol = 4, align = 'h')

#ggsave("Figures4.tiff", width = 40, height = 40, units = "cm", dpi=300)
```

```{r, fig.width = 40,fig.height=40} 
plot(figures4)
```

#Figure 5 is again made from dfa, so delete everything but dfa
```{r}
keep(dfa, sure = TRUE)
```
#Here is figure 5 
```{r}
dftrans<-dfa
amb<-dfa
dftrans<-subset(dftrans, dtrans >-8 & dtrans<2)
dftrans<-filter(dftrans, dftrans$sun == "day")
dftrans<-filter(dftrans, dftrans$rangewtc == "within")
dftrans$Camp<-as.factor(dftrans$Camp)
ggboxplot(dftrans, x = "trt", y = "dtrans",
          color = "trt", palette = c("#00AFBB", "#E7B800"),
          ylab = "dtrans", xlab = "trt")
res <- wilcox.test(dtrans ~ trt, data = dftrans,
                   exact = FALSE)
res
c1<-filter(dftrans, dftrans$Camp == "1")
c2<-filter(dftrans, dftrans$Camp == "3")
aovc1<- aov(c1$dtrans ~ c1$trt)
aovc2<-aov(c2$dtrans ~ c2$trt)
summary(aovc1)
summary(aovc2)
##Relative HUmidty
colnames(dftrans)
amb<-filter(amb, amb$chamber == "C01")
amb$Camp<-as.factor(amb$Camp)
astat<-lm( amb$d18O.corrected_WV.AMB. ~ amb$RHref_al_mean );summary(astat) # significant take these values (intercept slope r^2) 
a<-ggplot(data=amb, aes(x=RHref_al_mean, y=d18O.corrected_WV.AMB.))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  geom_smooth(method='lm', formula= y~x, se=FALSE)+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-16, -8))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 100))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
a
#stats for B
bstat<-lm( dftrans$d18O.corrected_WV ~dftrans$RH_al_mean );summary(bstat) #SIGNIFANT
b<-ggplot(data=dftrans, aes(x=RH_al_mean, y=d18O.corrected_WV))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  geom_smooth(method='lm', formula= y~x, se=FALSE)+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-16, -6))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 100))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
b
#stats for C
cstat<-lm(dftrans$dtrans ~ dftrans$RH_al_mean );summary(cstat) #siginfiant
c<-ggplot(data=dftrans, aes(x=RH_al_mean, y=dtrans))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  geom_smooth(method='lm', formula= y~x, se=FALSE)+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 100))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
c
#stats for C
cistat<-lm(dftrans$d18O.corrected_Cond ~ dftrans$RH_al_mean );summary(cistat) #siginfiant
ci<-ggplot(data=dftrans, aes(x=RH_al_mean, y=d18O.corrected_Cond))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  geom_smooth(method='lm', formula= y~x, se=FALSE)+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 100))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
ci


#VPD
amb$vpdatm<-RHtoVPD(RH=amb$RH_al, TdegC=amb$Tair_al, Pa = 101)
amb$vpdatm
estat<-lm( amb$d18O.corrected_WV.AMB. ~ amb$vpdatm );summary(estat) #NOT  significant
e<-ggplot(data=amb, aes(x=vpdatm, y=d18O.corrected_WV.AMB.))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-16, -8))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=4),
                       limits = c(0, 3))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
e
fstat<-lm( dftrans$d18O.corrected_WV ~dftrans$vpd );summary(fstat) #SIG
f<-ggplot(data=dftrans, aes(x=vpd, y=d18O.corrected_WV))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  geom_smooth(method='lm', formula= y~x, se=FALSE)+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-16, -6))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=4),
                       limits = c(0, 3))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
f
gstat<-lm( dftrans$dtrans ~dftrans$vpd );summary(gstat) #SIG
g<-ggplot(data=dftrans, aes(x=vpd, y=dtrans))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  geom_smooth(method='lm', formula= y~x, se=FALSE)+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=4),
                       limits = c(0, 3))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
g
gistat<-lm( dftrans$d18O.corrected_Cond ~dftrans$vpd );summary(gistat) #SIG
gi<-ggplot(data=dftrans, aes(x=vpd, y=d18O.corrected_Cond))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  geom_smooth(method='lm', formula= y~x, se=FALSE)+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=4),
                       limits = c(0, 3))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
gi

#Temp
istat<-lm( amb$d18O.corrected_WV.AMB. ~ amb$Taref_al_mean );summary(istat) # NOT
i<-ggplot(data=amb, aes(x=Taref_al_mean, y=d18O.corrected_WV.AMB.))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-16, -8))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 35))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
i
#Jstat
jstat<-lm( dftrans$d18O.corrected_WV ~dftrans$Tair_al_mean );summary(jstat) #SIGNIFANT
j<-ggplot(data=dftrans, aes(x=Tair_al_mean, y=d18O.corrected_WV))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  geom_smooth(method='lm', formula= y~x, se=FALSE)+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-16, -6))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 40))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
j
kstat<-lm(dftrans$dtrans ~ dftrans$Tair_al_mean );summary(kstat) #NOT
k<-ggplot(data=dftrans, aes(x=Tair_al_mean, y=dtrans))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 40))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
k
kistat<-lm(dftrans$d18O.corrected_Cond ~ dftrans$Tair_al_mean );summary(kistat) #NOT
ki<-ggplot(data=dftrans, aes(x=Tair_al_mean, y=d18O.corrected_Cond))+
  geom_point(aes(colour=trt, shape=Camp), size=2,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",labels = c("in", "out" ),values = c(16,2))+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(-8, 2))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(0, 40))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
ki
rh<-plot_grid(a,b,c,ci, align="vh", ncol =1 )
vpd<-plot_grid(e,f,g,gi, align="vh", ncol =1 )
temp<-plot_grid(i,j,k,ki, align="vh", ncol =1 )
figure4=plot_grid(temp,rh,vpd, align="vh", nrow=1)
#ggsave("newgraphcelluloseyaxisaddcond.tiff", width = 40, height = 60, units = "cm", dpi=300)
#again i used illustator to finish off
```

```{r, figure4, fig.width = 40,fig.height=60} 
plot(figure4)
```

#That finishes the campaign data 
```{r}
rm(list = ls())
```
#The next data we investigate is d18O cellulose, assimilation weighted temperture, VPD and RH, trunk growth and our PEX proxy.
# I used John Drakes code to calculate assimilation weighted values #https://github.com/jedrake/wtc4_flux/blob/master/R/combine_data_plot_assimiationWeightedLeafT.R  

```{r}
require(lubridate);require(ggplot2);require(xts);require(dplyr);require(grid);require(cowplot);require(ggpubr);
require(plantecophys);require(doBy)

#read in flux data to calculate CO2 assimilation 
googledriveWTC4dfID <- "10Y5-KjrbqeSaG6b_c6N7dJFGMsXSYqyq"
df<- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", googledriveWTC4dfID)) #best to load this in andthe # it out
##as it as an all vars file for whole period so quite large. 
df["Td"]<-(dmy_hm(df$DateTime, quiet=TRUE, tz="UTC"));str(df$Td)
df$halfhour = cut(df$Td, breaks= "60 min");
df$Date <- as.Date(df$Td)

# Dates to get data
period1start <- as.Date("2016-06-07")
period1end <- as.Date("2016-07-19")
period2start <- as.Date("2016-08-25")
period2end <- as.Date("2016-9-26")
period3start <- as.Date("2016-10-23")
period3end <- as.Date("2016-11-23")

#Calculate Flux
#if co2 flux is less then zero mulriiply it by 3 - this is respiration 
df$netresp<- ifelse(df$FluxCO2 <0, df$FluxCO2*3,  NA)
#is co2 flux is greater then zero this is assimliaton 
df$netasim <-ifelse(df$FluxCO2 >0, df$FluxCO2,  NA)

p1 <- subset(df, Date>=period1start & Date <=period1end)
p2 <- subset(df,  Date>=period2start & Date <=period2end)     
p3 <- subset(df, Date>=period3start & Date <=period3end)

p1sum<-summaryBy(.~chamber+T_treatment,FUN=c(sum),keep.names=T,data=p1,na.rm=TRUE)
p1sum$flux <-((p1sum$netasim +p1sum$netresp)*1440)/1000
p1sum$Period=1

p2sum<-summaryBy(.~chamber+T_treatment,FUN=c(sum),keep.names=T,data=p2,na.rm=TRUE)
p2sum$flux <-((p2sum$netasim+p2sum$netresp)*1440)/1000
p2sum$Period=2

p3sum<-summaryBy(.~chamber+T_treatment,FUN=c(sum),keep.names=T,data=p3,na.rm=TRUE)
p3sum$flux <-((p3sum$netasim+p3sum$netresp)*1440)/1000
p3sum$Period=3

dfFLUX<-rbind(p1sum,p2sum,p3sum)
#get growth data
googledrivestemdfID <- "1g1QXzgqcEgUH3n94BagWP0b6rBwY8EYc"
dfstem <- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", googledrivestemdfID))
dfPEX <- merge(dfFLUX,dfstem, by=c("chamber","Period"))
#get tree volume
dfPEX$sdiamM=dfPEX$Start.diam.mm./1000 #start diameter into meters
dfPEX$sheightM =dfPEX$start.Height.cm.../100 #start height in meters
#assume cone
dfPEX$ediamM=dfPEX$end.diam/1000 #end diameter into meters
dfPEX$eheightM =dfPEX$end.height/100 #end height in meters
dfPEX$vstart = (dfPEX$sheightM/3)*3.146*((dfPEX$sdiamM/2)^2) #volume start
dfPEX$vend = (dfPEX$eheightM/3)*3.146*((dfPEX$ediamM/2)^2) #volume end
dfPEX$volincrease=dfPEX$vend - dfPEX$vstart
dfPEX$PEX =dfPEX$netasim/dfPEX$volincrease;dfPEX$PEX
dfPEX$id <- paste(dfPEX$T_treatment.x,dfPEX$END.Date);dfPEXid<-as.factor(dfPEX$id);str(dfPEX$id)
labelsy=c("Period 1 (Ambient)", "Period 2 (Ambient)", "Period 3 (Ambient)",
          "Period 1 (Elevated)", "Period 2 (Elevated)", "Period 3 (Elevated)")
labels = c(expression(20~x~10^3),expression(40~x~10^3),expression(60~x~10^3),expression(80~x~10^3))
############
ggboxplot(dfPEX, x = "id", y = "PEX",
          color = "T_treatment.x", palette = c("black", "red"), width=.8,outlier.shape = NA)+
  geom_jitter(aes(colour = T_treatment.x), width=0.20, alpha=0.8)+
  theme_classic()+theme( panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+
  labs(y="", x = "", fill= "Technique")+
  theme(axis.title.y = element_text(angle = 90, vjust = 0, hjust=0.5, size= 18))+
  scale_y_continuous ( labels=labels, limits = c(20000, 80000))+
  scale_x_discrete(labels=labelsy)+
  theme(axis.text.y = element_text(angle = 30, vjust = 1, hjust=0.5, size= 25, color = "Black"))+
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size= 13, color = "Black"))+
  theme(legend.position="none")+ 
  labs(x="", y = "",element_text(size = 30))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))

dfPEX$Period<-as.factor(dfPEX$Period)
str(dfPEX)
pexamb<-filter(dfPEX, dfPEX$T_treatment.x==  "ambient")
pexhot<-filter(dfPEX, dfPEX$T_treatment.x==  "elevated")
pexstat<-lm(pexamb$d18Ocellulose ~  pexamb$PEX );summary(pexstat) #ambinet d18 vs pex  
pexstathot<-lm( pexhot$d18Ocellulose ~  pexhot$PEX );summary(pexstathot) #ambinet d18 vs pex  

pex<-ggplot(data=dfPEX, aes(x=PEX , y=d18Ocellulose))+
  geom_point(aes(colour=T_treatment.x, shape=Period), size=3.5,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",values = c(15,16,17))+
  geom_smooth(data=pexamb,method='lm', formula= y~x, se=FALSE, colour="black")+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(29, 36))+
  scale_x_continuous ( labels=labels, limits = c(20000, 80000))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=15,angle=45,hjust=1))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"));pex
```
#We now plot the other cellulose data 
```{r}

#this is the data frame with d18o cellulose and the assimliation weighted values 
googledriveWTC4ASWID <- "1Aq-2eFUC8xZHyacd88ePAhAwzfK4anCE"
dfcel<- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", googledriveWTC4ASWID)) #best to load this in andthe # it out
#dfcel<-summaryBy(.~T_treatment+Area,FUN=c(mean),keep.names=T,data=dfcel,na.rm=TRUE)
dfamb<-filter(dfcel, dfcel$T_treatment== "ambient")
dfhot<-filter(dfcel, dfcel$T_treatment== "elevated")

#####Relative Humidty 
rhastat<-lm( dfamb$d18O ~  dfamb$RHco2fluxweighted );summary(rhastat) #ambinet d18 vs rhassimlatino wighted SIG
rhastathot<-lm( dfhot$d18O ~  dfhot$RHco2fluxweighted );summary(rhastathot) #ambinet d18 vs rhassimlatino wighted SIG
rh<-ggplot(data=dfcel, aes(x=RHco2fluxweighted, y=d18O))+
  geom_point(aes(colour=T_treatment, shape=Area), size=3.5,)+
  scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",values = c(15,16,17))+
  geom_smooth(data=dfamb,method='lm', formula= y~x, se=FALSE, colour="black")+
  labs(y="", x = "",element_text(size = 6))+
  # scale_x_datetime(breaks = scales::pretty_breaks(n = 12))
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+
  scale_y_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(29, 36))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),
                       limits = c(55, 75))+
  theme(axis.text.y = element_text( color="black", size=25))+
  theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
rh
##########################
####VPD#####
vpdambstat<-lm( dfamb$d18O ~  dfamb$VPDco2fluxweighted );summary(vpdambstat) #amb d18 vs vpd wighted SIG
vpdhotstat<-lm( dfhot$d18O ~  dfhot$VPDco2fluxweighted );summary(vpdhotstat) #elevated d18 vs vpd wighted SIG
vpd<-ggplot(data=dfcel, aes(x=VPDco2fluxweighted, y=d18O))+
  geom_point(aes(colour=T_treatment, shape=Area), size=3.5,)+scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",values = c(15,16,17))+
  geom_smooth(data=dfamb,method='lm', formula= y~x, se=FALSE, colour="black")+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+scale_y_continuous ( breaks=scales::pretty_breaks(n=5), limits = c(29, 36))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),limits = c(0.5, 1.5))+
  theme(axis.text.y = element_text( color="black", size=25))+theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
vpd

##########################
####VPD#####
tempambstat<-lm( dfamb$d18O ~  dfamb$weightedMeanLeafT);summary(tempambstat) #amb d18 vs vpd wighted SIG
temphotstat<-lm( dfhot$d18O ~  dfhot$weightedMeanLeafT);summary(temphotstat) #elevated d18 vs vpd wighted SIG
temp<-ggplot(data=dfcel, aes(x=weightedMeanLeafT, y=d18O))+
  geom_point(aes(colour=T_treatment, shape=Area), size=3.5,)+scale_color_manual(name="Legend:",labels = c("Transpired Ambient Chamber", "Transpired Elevated Chamber"),values = c("black", "red"))+
  scale_shape_manual(name="Legend:",values = c(15,16,17))+
  geom_smooth(data=dfamb,method='lm', formula= y~x, se=FALSE, colour="black")+
  labs(y="", x = "",element_text(size = 6))+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  ggtitle("")+ theme(legend.position = "none")+scale_y_continuous ( breaks=scales::pretty_breaks(n=5), limits = c(29, 36))+
  scale_x_continuous ( breaks=scales::pretty_breaks(n=5),limits = c(15, 25))+
  theme(axis.text.y = element_text( color="black", size=25))+theme(axis.text.x = element_text( color="black", size=25))+
  theme(plot.margin = unit(c(5, 5, 5, 5), "mm"))
temp
figure5<-plot_grid(temp,rh,vpd,pex, align="vh", ncol=2)
#ggsave("cellulosegraphwithPEX.tiff", width = 30, height = 30, units = "cm", dpi=300)
```

```{r, fig.width = 30,fig.height=30} 
plot(figure5)
```


#the remaning plot is  SI3 (the multiple regression is in a .xls)
#to do this we needed to match a few data frames:
#wind + rain + d18oatm&FLUX

```{r}
library(data.table)
#Flux and Isotope Data
googledriveWTC4ISOTOPEID <- "1-lD4W_gdrlGssKnSpJw-3yIExXoCtdYw"
dfiso<- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", googledriveWTC4ISOTOPEID))
dfiso["Td"]<-(dmy_hm(dfiso$Td, quiet=TRUE, tz="UTC"));summary(dfiso$Td)
####AddVPD
dfiso$esat<-esat(TdegC=dfiso$Tair_al, Pa = 101)
dfiso$vpd<-RHtoVPD(RH=dfiso$RHref_al, TdegC=dfiso$Taref_al, Pa = 101) ; plot(dfiso$vpd);summary(dfiso$vpd) #VPD for ATM beacuse We used REFvalues
#Wind data
googledriveWind <- "1gQfK5zCCIEb6m4nWRHUV3mxWLu7KlwA2"
dfwind<- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", googledriveWind))
dfwind["Td"]<-(ymd_hms(dfwind$DateTime, quiet=TRUE, tz="UTC"));summary(dfwind$Td)
#Rain Data 
googledriveRain <- "1YEzDoVrDS-_jqv0jTl_CwlLhdTIs_caJ"
dfrain<- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", googledriveRain))
dfrain$Td<-(ymd_hms(dfrain$date, quiet=TRUE, tz="UTC"));summary(dfrain$Td)

start<-ymd_hms("2016-08-28 12:00:00 UTC");summary(start)
end<-ymd_hms("2016-11-26 12:00:00")
int<-interval(start, end); summary(int)
dfwind<-subset(dfwind, dfwind$Td %within% int)
dfiso<-subset(dfiso, dfiso$Td %within% int)
dfiso<-subset(dfiso,T_treatment == "ambient") ##  
dfiso<-subset(dfiso,chamber == "C03") # Since we are using ref values and atm we can just take an ambient chamber
dfrain<-subset(dfrain, dfrain$Td %within% int);max(dfrain$rain)

iso <- data.table(dfiso, key='Td')
wind <- data.table(dfwind, key='Td')
isowind<-wind[iso,roll='nearest',allow.cartesian=TRUE]
isowind<-na.omit(isowind);str(isowind)

isowindspeed<-data.table(isowind, key='Td')
raintable<-data.table(dfrain, key='Td')
allvars<-raintable[isowindspeed,roll='nearest',allow.cartesian=TRUE]
allvars$rain[is.na(allvars$rain)]<-0
plot(isowind$WS_ms_Avg, isowind$d18O.corrected)
plot(isowind$WindDir, isowind$d18O.corrected)
colnames(isowind)
#We want to test if VPD and Temp are prediectors of d18O
# d18 vs dir
ggscatter(isowind, x = "d18atm", y = "WindDir", 
          conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "d18", ylab = "direction")

dir <- cor.test(isowind$WindDir, isowind$d18atm, 
                method = "pearson")
dir
#d18 vs speed

ggscatter(isowind, x = "d18atm", y = "WS_ms_Avg", 
          add = "reg.line",conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "d18", ylab = "speed")

speed <- cor.test(isowind$WS_ms_Avg, isowind$d18atm, 
                  method = "pearson")
speed

colnames(isowindspeed)
multiple<-lm(d18atm ~ WS_ms_Avg + WindDir + Taref_al + vpd + RAIN, data =isowindspeed  )
summary(multiple)

si<-allvars

tlm<-lm(d18atm ~ Taref_al , data=si);summary(tlm)

tair<-ggplot(data=si, aes(x=Taref_al, y=d18atm))+
  geom_point(aes())+
  geom_smooth(method = "lm", se=FALSE, colour = "red")+
  labs(y= (bquote(delta^18*O~atm)), x="Air Temperature (?C) ")+
  ggtitle("(a) y= 0.0339x-13.982, R?=0.0072")+
  # theme(axis.line=element_blank())+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='none') 
tair

vlm<-lm(d18atm ~ vpd , data=si);summary(vlm)
vpd<-ggplot(data=si, aes(x=vpd, y=d18atm))+
  geom_point(aes())+
  #scale_colour_gradientn(colours = jet.colors(7))+
  # geom_smooth(method = "lm", se=FALSE, colour = "red")+
  labs(y= (bquote(delta^18*O~atm)), x="VPD (kPa) ")+
  # labs(fill=bquote(delta^18*O))+
  # labs(fill=("?C"))+
  ggtitle("(b)")+
  # theme(axis.line=element_blank())+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='none') 
# facet_wrap(vars(Cw.chamber), nrow = 4)
vpd

wslm<-lm(d18atm ~ WS_ms_Avg , data=si);summary(wslm)
windspeed<-ggplot(data=si, aes(x=WS_ms_Avg, y=d18atm))+
  geom_point(aes())+
  geom_smooth(method = "lm", se=FALSE, colour = "red")+
  labs(y= (bquote(delta^18*O~atm)), x="Wind Speed (m-s) ")+
  ggtitle("(c) y= -0.5015x-12.603, R?=0.0992")+
  # theme(axis.line=element_blank())+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='none') 
windspeed

wdlm<-lm(d18atm ~ WindDir , data=si);summary(wdlm)
winddirection<-ggplot(data=si, aes(x=WindDir, y=d18atm))+
  geom_point(aes())+
  geom_smooth(method = "lm", se=FALSE, colour = "red")+
  labs(y= (bquote(delta^18*O~atm)), x="Wind Direction (deg N) ")+
  ggtitle("(d) y= -0.0022x-13.057, R?=0.003")+
  # theme(axis.line=element_blank())+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='none') 
winddirection

rainlm<-lm(d18atm ~ rain , data=si);summary(rainlm)
rain<-ggplot(data=si, aes(x=rain, y=d18atm))+
  geom_point(aes())+
  geom_smooth(method = "lm", se=FALSE, colour = "red")+
  labs(y= (bquote(delta^18*O~atm)), x="Rain (mm)")+
  ggtitle("(e) y= -0.1688x-13.179, R?=0.046 ")+
  # theme(axis.line=element_blank())+
  theme_classic()+theme(panel.border = element_rect(fill = "NA", colour = "black", size = 2))+
  theme(text = element_text(size=17))+
  theme(axis.text=element_text(size=17))+ 
  theme(legend.position='none') 
rain
figsi3=plot_grid(tair, vpd, windspeed, winddirection, rain, ncol=1, nrow=5, align="vh")
ggsave("SI3LQ.tiff", width = 17, height = 35, units = "cm", dpi = 90)
```

```{r, fig.width = 5,fig.height=25} 
plot(figsi3)
```

#Done!



